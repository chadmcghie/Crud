name: Pull Request Validation

on:
  pull_request:
    branches: [ main, dev ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  build:
    name: Build Solution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Restore .NET dependencies
      run: dotnet restore Crud.sln
      
    - name: Build solution
      run: dotnet build Crud.sln --no-restore --configuration Release
      
    - name: Verify appsettings files exist
      run: |
        echo "ðŸ“ Verifying appsettings files before artifact upload:"
        ls -la src/Api/appsettings*.json
        echo "âœ… All appsettings files found"
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
        path: |
          src/*/bin/Release/
          test/*/bin/Release/
          src/Api/appsettings*.json
        retention-days: 1

  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
    
    - name: Copy appsettings to test output
      run: |
        echo "ðŸ“ Listing artifact structure:"
        ls -la src/Api/ || echo "src/Api/ not found"
        ls -la src/Api/bin/Release/net8.0/ || echo "bin directory not found"
        
        # Copy appsettings files if they exist
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from src/Api/"
        elif [ -f "appsettings.json" ]; then
          cp appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from root"
        else
          echo "âš ï¸ No appsettings files found to copy"
        fi
        
        echo "ðŸ“ Final output directory contents:"
        ls -la src/Api/bin/Release/net8.0/*.json || echo "No JSON files in output"
        
    - name: Run Backend Unit Tests
      run: dotnet test test/Tests.Unit.Backend/Tests.Unit.Backend.csproj --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=normal" --results-directory TestResults/
      
    - name: Upload backend unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-unit-tests-${{ github.run_number }}
        path: TestResults/
        
    - name: Publish backend unit test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Backend Unit Tests
        path: TestResults/*.trx
        reporter: dotnet-trx

  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
      
    - name: Install Angular dependencies
      working-directory: ./src/Angular
      run: npm ci
      
    - name: Lint check
      working-directory: ./src/Angular
      run: npm run lint
      
    - name: Run Angular Unit Tests with Coverage
      working-directory: ./src/Angular
      run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-unit-tests-${{ github.run_number }}
        path: src/Angular/coverage/

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
    
    - name: Copy appsettings to test output
      run: |
        echo "ðŸ“ Listing artifact structure:"
        ls -la src/Api/ || echo "src/Api/ not found"
        ls -la src/Api/bin/Release/net8.0/ || echo "bin directory not found"
        
        # Copy appsettings files if they exist
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from src/Api/"
        elif [ -f "appsettings.json" ]; then
          cp appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from root"
        else
          echo "âš ï¸ No appsettings files found to copy"
        fi
        
        echo "ðŸ“ Final output directory contents:"
        ls -la src/Api/bin/Release/net8.0/*.json || echo "No JSON files in output"
        
    - name: Run Backend Integration Tests with SQLite
      run: dotnet test test/Tests.Integration.Backend/Tests.Integration.Backend.csproj --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" --results-directory TestResults/
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
      timeout-minutes: 10
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-integration-tests-${{ github.run_number }}
        path: TestResults/
        
    - name: Publish backend integration test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Backend Integration Tests
        path: TestResults/*.trx
        reporter: dotnet-trx

  smoke-tests:
    name: Smoke Tests (Quick Validation)
    runs-on: ubuntu-latest
    needs: [build, backend-unit-tests, frontend-unit-tests, backend-integration-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
    
    - name: Copy appsettings to test output
      run: |
        echo "ðŸ“ Setting up smoke test environment..."
        echo "ðŸ“ Listing artifact structure:"
        ls -la src/Api/ || echo "src/Api/ not found"
        ls -la src/Api/bin/Release/net8.0/ || echo "bin directory not found"
        
        # Copy appsettings files - they should be in src/Api from the artifact
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from src/Api/"
        else
          echo "âŒ No appsettings files found in src/Api/"
          echo "ðŸ“ Checking current directory:"
          ls -la *.json 2>/dev/null || echo "No JSON files in root"
          exit 1
        fi
        
        echo "ðŸ“ Final output directory contents:"
        ls -la src/Api/bin/Release/net8.0/*.json || echo "No JSON files in output"
        
    - name: Run API Health Check Test
      run: |
        echo "ðŸ”¥ Running smoke test: API Health Check"
        dotnet test test/Tests.Integration.Backend/Tests.Integration.Backend.csproj \
          --no-build --configuration Release \
          --filter "FullyQualifiedName~ApiHealthTests.API_Should_Be_Responsive" \
          --logger "console;verbosity=normal" \
          --results-directory TestResults/
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
      continue-on-error: true
      
    - name: Run Basic CRUD Smoke Test
      run: |
        echo "ðŸ”¥ Running smoke test: Basic CRUD Operations"
        dotnet test test/Tests.Integration.Backend/Tests.Integration.Backend.csproj \
          --no-build --configuration Release \
          --filter "FullyQualifiedName~PeopleControllerTests.GET_People_Should_Return_Empty_List_Initially" \
          --logger "console;verbosity=normal" \
          --results-directory TestResults/
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
      continue-on-error: true
      
    - name: Run Simple Authentication Test
      run: |
        echo "ðŸ”¥ Running smoke test: Basic Authentication"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Running test with detailed logging..."
        dotnet test test/Tests.Integration.Backend/Tests.Integration.Backend.csproj \
          --no-build --configuration Release \
          --filter "FullyQualifiedName~AuthControllerTests.POST_Register_Should_Create_User_And_Return_Tokens" \
          --logger "console;verbosity=detailed" \
          --results-directory TestResults/ || (echo "Test failed with exit code: $?" && exit 1)
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
      continue-on-error: true
      
    - name: Smoke Test Summary
      if: always()
      run: |
        echo "## ðŸ”¥ Smoke Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Smoke tests are configured with continue-on-error to gather maximum diagnostic information." >> $GITHUB_STEP_SUMMARY
        echo "Check individual test steps above for specific failures." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if ls TestResults/*.trx 2>/dev/null; then
          echo "âœ… Smoke tests executed and produced results" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test result files found - smoke tests may not have executed properly" >> $GITHUB_STEP_SUMMARY
        fi

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.run_number }}
      
    - name: Install Angular dependencies
      working-directory: ./src/Angular
      run: npm ci
      
    - name: Build Angular for production
      working-directory: ./src/Angular
      run: npm run build
      
    - name: Install E2E test dependencies
      working-directory: ./test/Tests.E2E.NG
      run: npm ci
      
    - name: Install Playwright browsers
      working-directory: ./test/Tests.E2E.NG
      run: npx playwright install --with-deps chromium
      
    - name: Set execute permissions for API binary
      run: |
        chmod +x ./src/Api/bin/Release/net8.0/Api
        echo "âœ… Execute permissions set for API binary"
        
    - name: Run E2E Tests with WebServer Config
      working-directory: ./test/Tests.E2E.NG
      run: |
        echo "ðŸš€ Running E2E tests with Playwright WebServer configuration..."
        echo "This uses Playwright's built-in server management - no custom setup needed!"
        npm run test:webserver
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
        DatabaseProvider: SQLite
        TEST_RESET_TOKEN: test-only-token
        # Unique database per test run to avoid locking
        TEST_RUN_ID: ${{ github.run_id }}-${{ github.run_number }}
        
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-tests-${{ github.run_number }}
        path: |
          test/Tests.E2E.NG/playwright-report/
          test/Tests.E2E.NG/test-results/
          
    - name: Upload database files (for debugging)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: database-files-${{ github.run_number }}
        path: |
          CrudTest_*.db
          CrudTest_*.db-wal
          CrudTest_*.db-shm
          
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up test databases..."
        # Remove test database files created during this run
        rm -f CrudTest_*.db CrudTest_*.db-wal CrudTest_*.db-shm 2>/dev/null || true
        echo "âœ… Cleanup complete"

  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [build, backend-unit-tests, frontend-unit-tests, backend-integration-tests, e2e-tests]
    if: always()
    
    steps:
    - name: PR Status Check
      run: |
        echo "## ðŸ” Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || (needs.build.result == 'failure' && 'âŒ Failed') || (needs.build.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Unit Tests | ${{ needs.backend-unit-tests.result == 'success' && 'âœ… Passed' || (needs.backend-unit-tests.result == 'failure' && 'âŒ Failed') || (needs.backend-unit-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Unit Tests | ${{ needs.frontend-unit-tests.result == 'success' && 'âœ… Passed' || (needs.frontend-unit-tests.result == 'failure' && 'âŒ Failed') || (needs.frontend-unit-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Integration Tests | ${{ needs.backend-integration-tests.result == 'success' && 'âœ… Passed' || (needs.backend-integration-tests.result == 'failure' && 'âŒ Failed') || (needs.backend-integration-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| E2E Tests | ${{ needs.e2e-tests.result == 'success' && 'âœ… Passed' || (needs.e2e-tests.result == 'failure' && 'âŒ Failed') || (needs.e2e-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check overall status
        if [ "${{ needs.build.result }}" == "success" ] && 
           [ "${{ needs.backend-unit-tests.result }}" == "success" ] &&
           [ "${{ needs.frontend-unit-tests.result }}" == "success" ] &&
           [ "${{ needs.backend-integration-tests.result }}" == "success" ] &&
           [ "${{ needs.e2e-tests.result }}" == "success" ]; then
          echo "### âœ… All validation checks passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**E2E Tests:** Now using Playwright WebServer configuration for improved reliability" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âŒ Some validation checks failed" >> $GITHUB_STEP_SUMMARY
          echo "Please review the test results above for details." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi