name: Pull Request Validation

# This workflow handles comprehensive testing when PRs are opened or updated
# It runs in addition to feature-branch-tests.yml for thorough validation
on:
  pull_request:
    branches: [ main, dev, staging ]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Cancel in-progress runs for the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Changed from read to write for auto-formatting
  checks: write
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  # Simplified: Always build if needed. Try to download artifacts first, build if not available.
  build:
    name: Build Solution
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # Try to download feature artifacts first (optimization)
    - name: Download feature build artifacts (if available)
      id: download-artifacts
      uses: actions/download-artifact@v4
      with:
        name: feature-build-${{ github.sha }}
      continue-on-error: true
        
    - name: Check if build needed
      id: build-needed
      run: |
        if [ "${{ steps.download-artifacts.outcome }}" == "success" ] && [ -f "version.json" ]; then
          echo "needed=false" >> $GITHUB_OUTPUT
          echo "âœ… Feature build artifacts found - reusing"
          cat version.json | jq .
        else
          echo "needed=true" >> $GITHUB_OUTPUT
          echo "ðŸ”¨ No artifacts found - will build"
        fi
      
    - name: Setup .NET
      if: steps.build-needed.outputs.needed == 'true'
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Restore .NET dependencies
      if: steps.build-needed.outputs.needed == 'true'
      run: dotnet restore solutions/Crud.sln
      
    - name: Build solution
      if: steps.build-needed.outputs.needed == 'true'
      run: dotnet build solutions/Crud.sln --no-restore --configuration Release
      
    - name: Create versioned artifact (if built)
      if: steps.build-needed.outputs.needed == 'true'
      run: |
        echo "VERSION=${{ github.sha }}" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
        # Package with version info
        echo "{\"version\":\"${{ github.sha }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"branch\":\"${{ github.ref_name }}\",\"buildNumber\":\"${{ github.run_number }}\",\"workflow\":\"pr-validation\"}" > version.json
        
    - name: Verify appsettings files exist (if built)
      if: steps.build-needed.outputs.needed == 'true'
      run: |
        echo "ðŸ“ Verifying appsettings files before artifact upload:"
        ls -la src/Api/appsettings*.json
        echo "âœ… All appsettings files found"
      
    - name: Upload build artifacts (if built)
      if: steps.build-needed.outputs.needed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: pr-build-${{ github.sha }}
        path: |
          src/*/bin/Release/
          test/*/bin/Release/
          src/Api/appsettings*.json
          version.json
        retention-days: 7

  code-quality:
    name: Code Quality & Auto-Format
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.ref || github.ref_name }}
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
        
    - name: Auto-format Backend Code
      run: |
        echo "ðŸ”§ Auto-formatting C# code with dotnet format..."
        dotnet format solutions/Crud.sln
        echo "âœ… Formatting complete"
        
    - name: Frontend Linting
      working-directory: ./src/Angular
      run: |
        echo "ðŸ” Running Angular linting..."
        npm ci
        npm run lint
        
    - name: Commit and Push Formatting Changes
      run: |
        echo "ðŸ” Checking for formatting changes..."
        
        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add all changes including line ending normalization
        git add -A --renormalize
        
        # Check if there are any staged changes
        if ! git diff --staged --quiet; then
          echo "âœ¨ Formatting changes detected, committing..."
          git commit -m "style: auto-format code with dotnet format [skip ci]
        
        Applied automatic formatting to ensure consistent code style.
        This commit was automatically generated by GitHub Actions."
          
          # Push changes
          git push origin HEAD:${{ github.event.pull_request.head.ref || github.ref_name }}
          echo "âœ… Formatting changes pushed successfully"
          
          # IMPORTANT: Pull the changes back to update our local working copy
          echo "ðŸ“¥ Pulling formatting changes back to working copy..."
          git pull origin ${{ github.event.pull_request.head.ref || github.ref_name }}
        else
          echo "âœ… No formatting changes needed - code is already properly formatted"
        fi
        
    - name: Verify Final Formatting
      run: |
        echo "ðŸ” Verifying that all code is now properly formatted..."
        dotnet format solutions/Crud.sln --verify-no-changes --verbosity diagnostic
        if [ $? -ne 0 ]; then
          echo "âŒ ERROR: Code still has formatting issues after auto-format!"
          echo "This should not happen. Please check the workflow configuration."
          exit 1
        fi
        echo "âœ… All code is properly formatted and ready for merge!"
        
    - name: Check for common code issues
      run: |
        echo "ðŸ” Checking for common issues..."
        # Check for console.log in TypeScript files (except test files)
        if grep -r "console\.log" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=test --exclude-dir=tests src/Angular; then
          echo "âš ï¸ Warning: console.log statements found in production code"
        fi
        
        # Check for TODO comments that should be addressed
        if grep -r "TODO" --include="*.cs" --include="*.ts" --exclude-dir=node_modules src/; then
          echo "â„¹ï¸ Info: TODO comments found - consider addressing them"
        fi
        
    # Phase 3: SAST Integration (placeholder) 
    - name: Static Application Security Testing
      run: |
        echo "ðŸ”’ Running static application security testing..."
        # TODO: Integrate with SAST tools like:
        # - SonarCloud security scanning
        # - Snyk vulnerability scanning  
        # - OWASP dependency check
        # Note: CodeQL already exists in separate workflow
        echo "âœ… SAST placeholder complete - expand when security scanning is needed"

  backend-unit-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: feature-build-${{ github.sha }}
      continue-on-error: true
        
    - name: Download PR build artifacts (fallback)
      uses: actions/download-artifact@v4
      with:
        name: pr-build-${{ github.sha }}
      continue-on-error: true
    
    - name: Copy appsettings to test output
      run: |
        echo "ðŸ“ Listing artifact structure:"
        ls -la src/Api/ || echo "src/Api/ not found"
        ls -la src/Api/bin/Release/net8.0/ || echo "bin directory not found"
        
        # Copy appsettings files if they exist
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from src/Api/"
        elif [ -f "appsettings.json" ]; then
          cp appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from root"
        else
          echo "âš ï¸ No appsettings files found to copy"
        fi
        
        echo "ðŸ“ Final output directory contents:"
        ls -la src/Api/bin/Release/net8.0/*.json || echo "No JSON files in output"
        
    - name: Run Backend Unit Tests
      run: dotnet test test/Tests.Unit.Backend/Tests.Unit.Backend.csproj --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=normal" --results-directory TestResults/
      
    - name: Upload backend unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-unit-tests-${{ github.sha }}
        path: TestResults/
        
    - name: Publish backend unit test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Backend Unit Tests Summary
        path: TestResults/*.trx
        reporter: dotnet-trx

  frontend-unit-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    needs: [code-quality]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
      
    - name: Install Angular dependencies
      working-directory: ./src/Angular
      run: npm ci
      
    - name: Run Angular Unit Tests with Coverage
      working-directory: ./src/Angular
      run: npm run test -- --watch=false --browsers=ChromeHeadless --code-coverage --reporters=junit,coverage
      
    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-unit-tests-${{ github.sha }}
        path: src/Angular/coverage/
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: frontend-test-results-${{ github.sha }}
        path: src/Angular/test-results/
        
    - name: Publish frontend unit test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Frontend Unit Tests Summary
        path: src/Angular/test-results/*.xml
        reporter: java-junit

  backend-integration-tests:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: [build, code-quality]
    if: always() && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        cache: true
        cache-dependency-path: 'src/**/*.csproj'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: feature-build-${{ github.sha }}
      continue-on-error: true
        
    - name: Download PR build artifacts (fallback)
      uses: actions/download-artifact@v4
      with:
        name: pr-build-${{ github.sha }}
      continue-on-error: true
    
    - name: Copy appsettings to test output
      run: |
        echo "ðŸ“ Listing artifact structure:"
        ls -la src/Api/ || echo "src/Api/ not found"
        ls -la src/Api/bin/Release/net8.0/ || echo "bin directory not found"
        
        # Copy appsettings files if they exist
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from src/Api/"
        elif [ -f "appsettings.json" ]; then
          cp appsettings*.json src/Api/bin/Release/net8.0/
          echo "âœ… Appsettings files copied from root"
        else
          echo "âš ï¸ No appsettings files found to copy"
        fi
        
        echo "ðŸ“ Final output directory contents:"
        ls -la src/Api/bin/Release/net8.0/*.json || echo "No JSON files in output"
        
    - name: Run Backend Integration Tests with SQLite
      run: dotnet test test/Tests.Integration.Backend/Tests.Integration.Backend.csproj --no-build --configuration Release --logger "trx;LogFileName=test-results.trx" --logger "console;verbosity=detailed" --results-directory TestResults/
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
      timeout-minutes: 10
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backend-integration-tests-${{ github.sha }}
        path: TestResults/
        
    - name: Publish backend integration test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Backend Integration Tests Summary
        path: TestResults/*.trx
        reporter: dotnet-trx

  e2e-smoke-tests:
    name: E2E Smoke Tests (PRs to Main Only)
    runs-on: ubuntu-latest
    needs: [build, backend-unit-tests, frontend-unit-tests, backend-integration-tests]
    # Only run E2E tests for PRs to main (production). PRs to dev get E2E coverage in staging deployment.
    if: github.event.pull_request.base.ref == 'main' && needs.build.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
        
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: feature-build-${{ github.sha }}
      continue-on-error: true
        
    - name: Download PR build artifacts (fallback)
      uses: actions/download-artifact@v4
      with:
        name: pr-build-${{ github.sha }}
      continue-on-error: true
      
    - name: Install Angular dependencies
      working-directory: ./src/Angular
      run: npm ci
      
    - name: Build Angular for production
      working-directory: ./src/Angular
      run: npm run build
      
    - name: Install E2E test dependencies
      working-directory: ./test/Tests.E2E.NG
      run: npm ci
      
    - name: Install Playwright browsers
      working-directory: ./test/Tests.E2E.NG
      run: npx playwright install --with-deps chromium
      
    - name: Set execute permissions for API binary
      run: |
        chmod +x ./src/Api/bin/Release/net8.0/Api
        echo "âœ… Execute permissions set for API binary"
        
    - name: Run E2E Smoke Tests Only
      working-directory: ./test/Tests.E2E.NG
      run: |
        echo "ðŸš€ Running E2E smoke tests only for quick PR validation..."
        echo "Tagged with @smoke - should complete in 2-5 minutes"
        npm run test:smoke
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
        DatabaseProvider: SQLite
        TEST_RESET_TOKEN: test-only-token
        # Unique database per test run to avoid locking
        TEST_RUN_ID: ${{ github.run_id }}-${{ github.run_number }}
        
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-smoke-tests-${{ github.sha }}
        path: |
          test/Tests.E2E.NG/playwright-report/
          test/Tests.E2E.NG/test-results/
          
    - name: Upload database files (for debugging)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: database-files-${{ github.sha }}
        path: |
          CrudTest_*.db
          CrudTest_*.db-wal
          CrudTest_*.db-shm
          
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up test databases..."
        # Remove test database files created during this run
        rm -f CrudTest_*.db CrudTest_*.db-wal CrudTest_*.db-shm 2>/dev/null || true
        echo "âœ… Cleanup complete"

  pr-validation-summary:
    name: PR Validation Summary
    runs-on: ubuntu-latest
    needs: [build, backend-unit-tests, frontend-unit-tests, backend-integration-tests, e2e-smoke-tests]
    if: always()
    
    steps:
    - name: PR Status Check
      run: |
        echo "## ðŸ” Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ”„ Progressive Testing & Artifact Reuse" >> $GITHUB_STEP_SUMMARY
        echo "This PR validation reused build artifacts from the feature branch to avoid redundant compilation." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show different messaging based on target branch
        if [ "${{ github.event.pull_request.base.ref }}" == "dev" ]; then
          echo "**Target Branch:** \`dev\` (Development) - Progressive testing strategy" >> $GITHUB_STEP_SUMMARY
          echo "**E2E Testing:** Will run during staging deployment after merge" >> $GITHUB_STEP_SUMMARY
        else
          echo "**Target Branch:** \`${{ github.event.pull_request.base.ref }}\` (Production path)" >> $GITHUB_STEP_SUMMARY
          echo "**E2E Testing:** Required before merge" >> $GITHUB_STEP_SUMMARY
        fi
        echo "**Build Strategy:** Reusing artifacts from feature branch build (no rebuild)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Build status
        BUILD_STATUS="âŒ Failed"
        if [ "${{ needs.build.result }}" == "success" ]; then
          BUILD_STATUS="âœ… Success"
        fi
        
        echo "| Build | $BUILD_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Unit Tests | ${{ needs.backend-unit-tests.result == 'success' && 'âœ… Passed' || (needs.backend-unit-tests.result == 'failure' && 'âŒ Failed') || (needs.backend-unit-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Frontend Unit Tests | ${{ needs.frontend-unit-tests.result == 'success' && 'âœ… Passed' || (needs.frontend-unit-tests.result == 'failure' && 'âŒ Failed') || (needs.frontend-unit-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Backend Integration Tests | ${{ needs.backend-integration-tests.result == 'success' && 'âœ… Passed' || (needs.backend-integration-tests.result == 'failure' && 'âŒ Failed') || (needs.backend-integration-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        
        # E2E tests status - different handling for dev vs main PRs
        if [ "${{ github.event.pull_request.base.ref }}" == "dev" ]; then
          echo "| E2E Smoke Tests | â­ï¸ Skipped (will run in staging) |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| E2E Smoke Tests | ${{ needs.e2e-smoke-tests.result == 'success' && 'âœ… Passed' || (needs.e2e-smoke-tests.result == 'failure' && 'âŒ Failed') || (needs.e2e-smoke-tests.result == 'cancelled' && 'â¹ï¸ Cancelled') || 'â¸ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check overall status - different logic for dev vs main PRs
        if [ "${{ github.event.pull_request.base.ref }}" == "dev" ]; then
          # For dev PRs, don't require E2E tests
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.backend-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.frontend-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.backend-integration-tests.result }}" == "success" ]; then
            echo "### âœ… All validation checks passed for dev branch!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Progressive Testing:** E2E tests will run automatically during staging deployment" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some validation checks failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test results above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        else
          # For main PRs, require E2E tests
          if [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.backend-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.frontend-unit-tests.result }}" == "success" ] && \
             [ "${{ needs.backend-integration-tests.result }}" == "success" ] && \
             [ "${{ needs.e2e-smoke-tests.result }}" == "success" ]; then
            echo "### âœ… All validation checks passed for main branch!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**E2E Tests:** Smoke tests completed (~22 tests) for production readiness" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Some validation checks failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the test results above for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
        fi