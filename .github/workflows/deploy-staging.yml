name: Deploy to Staging

on:
  push:
    branches: [ dev ]
  workflow_dispatch:  # Allow manual trigger

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  # Skip deployment if it's a Copilot commit or if no PR artifacts are available
  check-commit:
    name: Check Deployment Prerequisites
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      artifact-exists: ${{ steps.artifact-check.outputs.artifact-exists }}
    
    steps:
    - name: Check if Copilot commit
      id: check
      run: |
        if [[ "${{ github.event.head_commit.author.email }}" == *"copilot"* ]] || 
           [[ "${{ github.event.head_commit.author.name }}" == *"copilot"* ]]; then
          echo "should-deploy=false" >> $GITHUB_OUTPUT
          echo "‚è≠Ô∏è Skipping deployment - Copilot commit detected"
        else
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Proceeding with staging deployment"
        fi
        
    - name: Check for dev artifacts
      id: artifact-check
      run: |
        # This will be verified when we try to download the artifact
        echo "artifact-exists=true" >> $GITHUB_OUTPUT
        echo "üì¶ Will attempt to download dev-artifact-${{ github.sha }}"

  staging-smoke-tests:
    name: Staging Smoke Tests (Build Fresh Artifacts)
    runs-on: ubuntu-latest
    needs: check-commit
    if: needs.check-commit.outputs.should-deploy == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore .NET dependencies
      run: dotnet restore solutions/Crud.sln
      
    - name: Build solution for staging
      run: |
        echo "üèóÔ∏è Building solution for staging deployment..."
        dotnet build solutions/Crud.sln --no-restore --configuration Release
        
    - name: Create versioned artifact for staging
      run: |
        echo "üì¶ Creating version info for staging deployment..."
        echo "{\"version\":\"${{ github.sha }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"branch\":\"${{ github.ref_name }}\",\"buildNumber\":\"${{ github.run_number }}\",\"environment\":\"staging\"}" > version.json
        cat version.json
        
    - name: Verify build artifacts
      run: |
        echo "üìÅ Verifying build outputs for staging:"
        ls -la src/Api/bin/Release/net8.0/ || echo "‚ö†Ô∏è API build directory not found"
        echo "üìã Version info:"
        cat version.json
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
        
    # Install Angular dependencies so the dev server can start
    - name: Install Angular dependencies
      working-directory: ./src/Angular
      run: |
        echo "üì¶ Installing Angular dependencies for smoke tests..."
        npm ci
        echo "‚úÖ Angular dependencies installed"
        
    # Verify Angular can compile and run
    - name: Verify Angular setup
      working-directory: ./src/Angular
      run: |
        echo "üîç Verifying Angular can compile..."
        npm run ng -- version
        echo "‚úÖ Angular CLI verified"
        
    # Copy appsettings files for the backend
    - name: Copy appsettings to build output
      run: |
        echo "üìÅ Copying appsettings files to build output..."
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json src/Api/bin/Release/net8.0/
          echo "‚úÖ Appsettings files copied"
          ls -la src/Api/bin/Release/net8.0/*.json
        else
          echo "‚ö†Ô∏è No appsettings files found"
        fi
        
    # Install E2E dependencies
    - name: Install E2E dependencies
      working-directory: ./test/Tests.E2E.NG
      run: |
        npm ci
        npx playwright install --with-deps chromium
        
    # Run smoke tests only - targeting 2 minutes as per issue requirements  
    - name: Run staging-specific smoke tests
      working-directory: ./test/Tests.E2E.NG
      run: |
        echo "üöÄ Running staging smoke tests only (targeting ~2 minutes)..."
        echo "Using fresh build artifacts for staging environment"
        npm run test:smoke  # Instead of full suite
      env:
        CI: true
        ASPNETCORE_ENVIRONMENT: Testing
        DatabaseProvider: SQLite
        TEST_RESET_TOKEN: test-only-token
        TEST_RUN_ID: staging-${{ github.run_id }}-${{ github.run_number }}
        
    - name: Upload staging test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: staging-smoke-tests-${{ github.sha }}
        path: |
          test/Tests.E2E.NG/playwright-report/
          test/Tests.E2E.NG/test-results/
        retention-days: 7

  prepare-staging-artifacts:
    name: Prepare Staging Deployment Artifacts (Build Fresh)
    runs-on: ubuntu-latest
    needs: staging-smoke-tests
    if: needs.staging-smoke-tests.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'src/Angular/package-lock.json'
        
    - name: Restore .NET dependencies
      run: dotnet restore solutions/Crud.sln
      
    - name: Build backend for staging
      run: |
        echo "üèóÔ∏è Building backend for staging deployment..."
        dotnet build solutions/Crud.sln --no-restore --configuration Release
        
    # Build Angular for staging config
    - name: Build frontend for staging
      working-directory: ./src/Angular
      run: |
        echo "üèóÔ∏è Building Angular for staging configuration..."
        npm ci
        npm run build -- --configuration=staging
        echo "‚úÖ Frontend built for staging configuration"
        
    # Package backend binaries
    - name: Package backend for staging
      run: |
        echo "üì¶ Packaging backend for staging deployment..."
        # Verify the build output exists
        if [ ! -d "src/Api/bin/Release/net8.0" ]; then
          echo "‚ùå ERROR: Backend build output not found!"
          echo "Expected: src/Api/bin/Release/net8.0/"
          exit 1
        fi
        
        # Package the backend
        mkdir -p ./staging-backend
        cp -r src/Api/bin/Release/net8.0/* ./staging-backend/
        
        # Copy appsettings files
        if [ -f "src/Api/appsettings.json" ]; then
          cp src/Api/appsettings*.json ./staging-backend/
          echo "‚úÖ Appsettings files copied to staging package"
        fi
        
        # Create version info for staging
        echo "{\"version\":\"${{ github.sha }}\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"branch\":\"${{ github.ref_name }}\",\"buildNumber\":\"${{ github.run_number }}\",\"environment\":\"staging\"}" > ./staging-backend/version.json
        echo "üìã Version info added:"
        cat ./staging-backend/version.json
        
        cd ./staging-backend
        zip -r ../staging-api.zip .
        cd ..
        echo "‚úÖ Backend packaged for staging"
        
    - name: Package frontend
      run: |
        echo "üì¶ Packaging frontend build..."
        cd ./src/Angular/dist
        zip -r ../../../staging-frontend.zip .
        cd ../../..
        echo "‚úÖ Frontend packaged"
        
    - name: Upload staging artifacts
      uses: actions/upload-artifact@v4
      with:
        name: staging-artifacts-${{ github.sha }}
        path: |
          staging-api.zip
          staging-frontend.zip
        retention-days: 7

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: prepare-staging-artifacts
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: staging-artifacts-${{ github.sha }}
        
    # ====================================
    # Staging Deployment
    # ====================================
    # Configure deployment based on your hosting platform
    # Uncomment and modify the appropriate section below:
    
    # --- Option 1: Azure App Service ---
    # - name: Deploy to Azure Web App
    #   uses: azure/webapps-deploy@v2
    #   with:
    #     app-name: 'your-app-staging'
    #     publish-profile: ${{ secrets.AZURE_STAGING_PUBLISH_PROFILE }}
    #     package: staging-api.zip
    
    # --- Option 2: AWS Elastic Beanstalk ---
    # - name: Deploy to AWS EB
    #   uses: einaregilsson/beanstalk-deploy@v21
    #   with:
    #     aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     application_name: your-app
    #     environment_name: your-app-staging
    #     version_label: ${{ github.sha }}
    #     region: us-east-1
    #     deployment_package: staging-api.zip
    
    # --- Option 3: Docker/Kubernetes ---
    # - name: Build and push Docker image
    #   run: |
    #     docker build -t your-registry/your-app:staging-${{ github.sha }} .
    #     docker push your-registry/your-app:staging-${{ github.sha }}
    # - name: Deploy to Kubernetes
    #   run: |
    #     kubectl set image deployment/your-app your-app=your-registry/your-app:staging-${{ github.sha }} -n staging
    
    # --- Option 4: IIS/Windows Server (self-hosted runner) ---
    # - name: Deploy to IIS
    #   run: |
    #     Stop-WebSite -Name "YourApp-Staging"
    #     Expand-Archive -Path staging-api.zip -DestinationPath C:\inetpub\staging\api -Force
    #     Expand-Archive -Path staging-frontend.zip -DestinationPath C:\inetpub\staging\www -Force
    #     Start-WebSite -Name "YourApp-Staging"
    
    # --- Default: Placeholder for manual configuration ---
    - name: Deploy to staging
      id: deploy
      run: |
        echo "üöÄ Deploying to staging environment..."
        echo "Version: ${{ github.sha }}"
        # Replace this section with actual deployment commands
        # Example: Copy files to server, restart services, etc.
        echo "url=https://staging.your-app.com" >> $GITHUB_OUTPUT
        
    - name: Verify deployment health
      run: |
        echo "üè• Checking staging deployment health..."
        # Uncomment and modify for your staging URL:
        # curl -f ${{ steps.deploy.outputs.url }}/health || exit 1
        echo "‚úÖ Staging deployment healthy"
        
    - name: Run post-deployment tests
      run: |
        echo "üß™ Running post-deployment smoke tests..."
        # Add API endpoint tests, critical user flow tests, etc.
        echo "‚úÖ Post-deployment tests passed"

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: always()
    
    steps:
    - name: Create deployment summary
      run: |
        echo "## üöÄ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ${{ needs.deploy-staging.result == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow run**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.deploy-staging.result }}" == "success" ]; then
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test the staging environment" >> $GITHUB_STEP_SUMMARY
          echo "2. Get stakeholder approval" >> $GITHUB_STEP_SUMMARY
          echo "3. Create PR from \`dev\` ‚Üí \`main\` for production deployment" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ö†Ô∏è Action Required" >> $GITHUB_STEP_SUMMARY
          echo "The staging deployment failed. Please check the logs and fix any issues." >> $GITHUB_STEP_SUMMARY
        fi
        
    # --- Notification Options ---
    # Uncomment and configure the appropriate notification method:
    
    # Option 1: Slack notification
    # - name: Notify Slack
    #   if: always()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     text: |
    #       Staging Deployment ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }}
    #       Version: ${{ github.sha }}
    #       Environment: Staging
    #       Deployed by: ${{ github.actor }}
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    
    # Option 2: Microsoft Teams notification
    # - name: Notify Teams
    #   if: always()
    #   uses: jdcargile/ms-teams-notification@v1.3
    #   with:
    #     github-token: ${{ github.token }}
    #     ms-teams-webhook-uri: ${{ secrets.TEAMS_WEBHOOK }}
    #     notification-summary: Staging Deployment ${{ job.status }}
    #     notification-color: ${{ job.status == 'success' && '00FF00' || 'FF0000' }}
    
    # Option 3: Email notification
    # - name: Send email notification
    #   if: always()
    #   uses: dawidd6/action-send-mail@v3
    #   with:
    #     server_address: smtp.gmail.com
    #     server_port: 465
    #     username: ${{ secrets.EMAIL_USERNAME }}
    #     password: ${{ secrets.EMAIL_PASSWORD }}
    #     subject: Staging Deployment ${{ job.status }} - ${{ github.sha }}
    #     to: devops@your-company.com
    #     from: GitHub Actions
    #     body: |
    #       Staging deployment has ${{ job.status }}.
    #       Version: ${{ github.sha }}
    #       Deployed by: ${{ github.actor }}
    #       View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    # - name: Send Slack notification
    #   if: always()
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     text: 'Staging deployment ${{ needs.deploy-staging.result }}'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}